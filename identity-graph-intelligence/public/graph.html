<html>
<head>
    <link href="/stylesheets/style.css" type="text/css" rel="stylesheet" />
</head>
<body>
<div id="header">
    <span id="form" style="border: 1px dotted #107E92;display:table-cell;width: 400px;">
        <form action="" name="myform">
            imid or txn id : <label for="id"></label><input type="text" name="id" id="id"><br>
            merchant id : <label for="mid"></label><input type="text" name="mid" id="mid"><br>
            <input type="button" value="Submit" id="submit" onclick="loadData()"/>
        </form>
    </span>
    <span id="form2" style="border: 1px dotted #107E92;display:table-cell;width: 400px;">
        <form action="" name="myform2">
            max entities    : <input type="text" id="maxEntities" value="100"/><br>
            depth           : <input type="text" id="depth" value="5"/><br>
            traverse tagged : <input type="text" id="traverse" value="false"/><br>
            traverse dest   : <input type="text" id="destination" value="false"/><br>
        </form>
    </span>
    <span id="form3" style="border: 1px dotted #107E92;display:table-cell;width: 400px;">
        <form action="" name="myform2">
            search for   : <input type="text" id="search"/><br>
            <input type="button" value="Search" id="searchButton" onclick='searchGraph(document.getElementById("search").value.trim(), true)'/>
            <input type="button" value="Reset" id="resetButton" onclick='resetGraph()'/>
        </form>
    </span>
</div>


<div id="container">
    <div id="metricsColumn">
        <div id="metricsContainer" > </div>
    </div>
    <div id="graphContainer"> </div>
    <span id="entityContainer" > </span>
</div>
<div id="linkContainer"> </div>

<script src="sigmajs/sigma.min.js"></script>
<script src="sigmajs/plugins/sigma.exporters.svg.min.js"></script>
<script src="sigmajs/plugins/sigma.layout.forceAtlas2.min.js"></script>
<script src="sigmajs/plugins/sigma.layout.noverlap.min.js"></script>
<script src="sigmajs/plugins/sigma.neo4j.cypher.min.js"></script>
<script src="sigmajs/plugins/sigma.parsers.gexf.min.js"></script>
<script src="sigmajs/plugins/sigma.parsers.json.min.js"></script>
<script src="sigmajs/plugins/sigma.pathfinding.astar.min.js"></script>
<script src="sigmajs/plugins/sigma.plugins.animate.min.js"></script>
<script src="sigmajs/plugins/sigma.plugins.dragNodes.min.js"></script>
<script src="sigmajs/plugins/sigma.plugins.filter.min.js"></script>
<script src="sigmajs/plugins/sigma.plugins.neighborhoods.min.js"></script>
<script src="sigmajs/plugins/sigma.plugins.relativeSize.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.customEdgeShapes.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.customShapes.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.edgeDots.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.edgeLabels.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.parallelEdges.min.js"></script>
<script src="sigmajs/plugins/sigma.renderers.snapshot.min.js"></script>
<script src="sigmajs/plugins/sigma.statistics.HITS.min.js"></script>

<script src="js/sigma.plugins.tooltips.js"></script>
<script src="js/mustache-0.8.1.min.js"></script>

<script src="js/entitygraph.js"></script>



<script>

  // whether to enable global admin features.  The API will authenticate before performing any actions!
  var globalAdminLoggedIn = false;
  var gg;          // once the (sigma) graph is loaded this will be a reference to it
  var highlightColor = 'lightgrey';
  var highlightStrokeWidth = 4;


  function loadData() {
    loadGraph(document.getElementById("id").value.trim(),
      document.getElementById("mid").value.trim(),
      'graphContainer', 'metricsContainer', 'entityContainer');
  }

  /**
   * Load the sigma.js entity graph into the elements
   * @param id
   * @param graphElementId    target for the sigma graph
   * @param metricsElementId  target for the graph metrics
   */
  function loadGraph(id, mid, graphElementId, metricsElementId, entityElementId) {

    document.getElementById(graphElementId).innerHTML = "";

    console.log("Load graph", id);

    var max = document.getElementById("maxEntities").value.trim();
    var depth = document.getElementById("depth").value.trim();
    var traverse = document.getElementById("traverse").value.trim();
    var destination = document.getElementById("destination").value.trim();
    var url = getBaseURL() + "entitygraph/v2/graph"
      + "?metrics=true"
      + "&transactionRecord=true"
      + "&depth=" + depth
      + "&maxEntities=" + max
      + "&traverse=" + traverse
      + "&includeDestination=" + destination
      + (mid.length > 0 ? "&mid=" + mid : "")
      + "&id=" + id;
    loadEntityGraphJSON(url,
      {
        container: graphElementId,
        settings: {
          defaultNodeColor: 'gray',
          defaultEdgeColor: '#E0E0E0',
          edgeColor: 'default',
          minNodeSize: 1,
          maxNodeSize: 20,
          labelThreshold: 16,
          enableEdgeHovering: true,
        },
        renderer: {
          container: document.getElementById(graphElementId), type: 'canvas'
        }
      }, function (g, graph) {
        gg = g;
        document.getElementById(metricsElementId).innerHTML = "";

        document.getElementById(metricsElementId).appendChild(document.createElement('pre')).innerHTML =
          '<div class="metrics-table">' +
          '    <table>' +
          '      <tr><th align="left">Graph Root</th> <td>' + id + '</td></tr>' +
          '      <tr><th align="left">Graph Score</th> <td>' + graph.metrics.score + '</td></tr>' +
          '      <tr><th align="left">Total Entities</th> <td>' + graph.metrics.entities + '</td></tr>' +
          '      <tr><th align="left">Total Bad Entities</th> <td>' + (graph.metrics.entitiesByReputation.BAD === undefined ? 0 : graph.metrics.entitiesByReputation.BAD) + '</td></tr>' +
          '      <tr><th align="left">Total CB/Fraud Rfnd</th> <td>' + graph.metrics.chargeBackAndFraudRefundCount + '</td></tr>' +
          '      <tr><th align="left">Client Count</th> <td>' + graph.metrics.uniqueClientCount + '</td></tr>' +
          '      <tr><th align="left">Tags</th> <td>' + Object.keys(graph.metrics.entityTags) + '</td></tr>' +
          '    </table>' +
          '<\div><br>';

        if (graph.txn)  {
          document.getElementById(metricsElementId).appendChild(document.createElement('pre')).innerHTML =
            '<div class="metrics-table">' +
            '    <table>' +
            '      <tr><th align="left">Policy Result</th> <td>' + graph.txn.tsu + '</td></tr>' +
            '      <tr><th align="left">Edna Result</th> <td>' + graph.txn.aur + '</td></tr>' +
            '      <tr><th align="left">Merchant Status</th> <td>' + (graph.txn.mtst === undefined ? "" : graph.txn.mtst) + '</td></tr>' +
            '      <tr><th align="left">Merchant Txn Id</th> <td>' + graph.txn.mid + '</td></tr>' +
            '      <tr><th align="left">Internal Txn Id</th> <td>' + graph.txn.tid + '</td></tr>' +
            '      <tr><th align="left">Merchant Id</th> <td>' + graph.txn.merchantId + '</td></tr>' +
            '      <tr><th align="left">Transaction Type</th> <td>' + graph.txn.tt + '</td></tr>' +
            '    </table>' +
            '<\div><br>';
        }

        document.getElementById(metricsElementId).appendChild(document.createElement('pre')).innerHTML = JSON.stringify(graph.metrics, null, 2);

        if (graph.txn) {
          document.getElementById(metricsElementId).appendChild(document.createElement('pre')).innerHTML = JSON.stringify(graph.txn, null, 2);

          if (graph.txn.pid)
            searchGraph("p:" + graph.txn.pid, false);
          if (graph.txn.did)
            searchGraph("d:" + graph.txn.did, false);
          if (graph.txn.bid)
            searchGraph("u:" + graph.txn.bid, false);
          if (graph.txn.blid)
            searchGraph("a:" + graph.txn.blid, false);
          if (graph.txn.aid)
            searchGraph("a:" + graph.txn.aid, false)
        } else {
          searchGraph(id, false);
        }

        gg.startForceAtlas2();
        var maxLayoutTimeMS = 300;
        if (graph.metrics.entities > 100)
          maxLayoutTimeMS = 1000;
        if (graph.metrics.entities > 1000)
          maxLayoutTimeMS = 5000;
        // don't burn up the browsers CPU forever
        setTimeout(function () { gg.stopForceAtlas2(); }, maxLayoutTimeMS);

        gg.bind('clickNode', function(e) {
          loadEntity(e.data.node.id, e.data.node.label, entityElementId)
            /*
             var c = gg.camera;
             console.log("zoom")
             c.goTo({ratio: c.ratio / c.settings('zoomingRatio')});
             */
        });

        gg.bind('overNode', function(nn) {
          hideNonNeighbours(nn,gg);
        });

        gg.bind('outNode', function(nn) {
          allUnhidden(nn,gg);
        });

        // https://github.com/Linkurious/linkurious.js/blob/develop/examples/plugin-tooltips.html
        var tooltipInstance = sigma.plugins.tooltips(
          gg,
          gg.renderers[0],
          {
            node: [{
              show: 'clickNode',
              hide: 'click',
              position: 'left',
              template:
              '<div class="arrow"></div>' +
              ' <div class="sigma-tooltip-header">{{label}}</div>' +
              '  <div class="sigma-tooltip-body">' +
              '    <table>' +
              '      <tr><th>Type</th> <td>{{typeString}}</td></tr>' +
              '      <tr><th>Trust</th> <td>{{trust}}</td></tr>' +
              '      <tr><th>Seen Count</th> <td>{{seenCount}}</td></tr>' +
              '      <tr><th>Merchants</th> <td>{{merchantCount}}</td></tr>' +
              '      <tr><th>Seen by me</th> <td>{{seenAtMerchant}}</td></tr>' +
              '      <tr><th>First Seen</th> <td>{{firstSeen}}</td></tr>' +
              '      <tr><th>Recent Seen</th> <td>{{mostRecentlySeen}}</td></tr>' +
              '      <tr><th>Entity Tags</th> <td>{{tags}}</td></tr>' +
              '    </table>' +
              '  </div>' +
              '  <div class="sigma-tooltip-footer">Number of connections: {{degree}}</div>',
              renderer: function(node, template) {
                // The function context is s.graph
                node.degree = this.degree(node.id);
                // Returns an HTML string:
                return Mustache.render(template, node);
                // Returns a DOM Element:
                //var el = document.createElement('div');
                //return el.innerHTML = Mustache.render(template, node);
              }

            }],
            edge: [{
              show: 'overEdge',
              hide: 'outEdge',
              delay: 300,
              template:
              '<div class="arrow"></div>' +
              ' <div class="sigma-tooltip-header">{{relationships}}</div>' +
              '  <div class="sigma-tooltip-body">' +
              '    <table>' +
              '      <tr><th>First Seen</th> <td>{{firstSeen}}</td></tr>' +
              '      <tr><th>Recent Seen</th> <td>{{mostRecentlySeen}}</td></tr>' +
              '    </table>' +
              '  </div>',
              renderer: function(edge, template) {
                // The function context is s.graph
                edge.degree = this.degree(edge.id);
                // Returns an HTML string:
                return Mustache.render(template, edge);
                // Returns a DOM Element:
                //var el = document.createElement('div');
                //return el.innerHTML = Mustache.render(template, node);
              }                                }]
          }
        );

        // initialize drag & drop plugin
        sigma.plugins.dragNodes(gg, gg.renderers[0]);

      });

    // if it looks like an imid, load the entity
    if (id.substring(1,2) == ':')
      loadEntity(id, '', 'entityContainer');

    {
      // link for JSON
      //
      document.getElementById('linkContainer').innerHTML = "";
      var aLink = document.createElement('a');
      document.getElementById('linkContainer').appendChild(aLink);
      var linkText = document.createTextNode("Adjacency List Download");
      aLink.appendChild(linkText);
      aLink.title = "Adjacency List Download";
      aLink.href = url;
    }
  }

</script>
</body>
</html>
